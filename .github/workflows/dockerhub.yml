name: Build & Push Telegraf to DockerHub (master)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: write   # needed to commit BuildVersion + push git tag

jobs:
  build-and-push:
    # prevent loops when we commit back BuildVersion
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest

    env:
      DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}  # docker hub namespace (can differ from GH org)
      IMAGE_NAME:        ${{ vars.IMAGE_NAME }}           # docker hub repo name (e.g., taplane-telegraf)
      PLATFORMS:         linux/amd64,linux/arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed for tags

      - name: Bump BuildVersion
        id: version
        shell: bash
        run: |
          CURRENT="$(cat BuildVersion 2>/dev/null || echo "0.0.0")"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          PATCH="${PATCH:-0}"
          NEW_PATCH=$((PATCH + 1))
          TAG="${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "$TAG" > BuildVersion
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Commit BuildVersion + Tag
        shell: bash
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name  "github-actions[bot]"

          git add BuildVersion
          git commit -m "chore([skip ci]): bump BuildVersion to $TAG" || echo "No changes to commit"

          git tag -f "$TAG"
          git push origin HEAD:master --tags --force

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push (multi-arch)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: ${{ env.PLATFORMS }}
          build-args: |
            VERSION=${{ steps.version.outputs.tag }}
            COMMIT=${{ github.sha }}
            BRANCH=${{ github.ref_name }}
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.tag }}
            ${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest

# Zabbix Output Plugin for Telegraf

This plugin send metrics to [Zabbix](https://www.zabbix.com/) via [traps](https://www.zabbix.com/documentation/3.4/manual/config/items/itemtypes/trapper).

## Trap format
For each new metric generated by Telegraf, this output plugin will send one trap for each field.

> Note: measurement name can be skipped in lld keys

For a metric in Telegraf format:
```
measurement,host=hostname valueA=0,valueB=1
->
measurement.valueA
measurement.valueB
```

If the metric has tags, they will be added, in alphabetical order, like:
```
measurement,host=hostname,tagA=keyA,tagB,keyB valueA=0,valueB=1
->
measurement.valueA[keyA,keyB]
measurement.valueB[keyA,keyB]
```

## Configuration

```toml
# Configuration for Zabbix to send metrics to.
[[outputs.zabbix]]
	## Address of zabbix host
	host = "zabbix.example.com"

	## Port of the Zabbix server
	port = 10051

	## Send metrics as type "Zabbix agent (active)" (default false)
	agent_active = false

	## Add prefix to all keys sent to Zabbix (default empty)
	prefix = "telegraf."

	## Skip measurement prefix to all keys sent to Zabbix (false by default)
	skip_measurement_prefix = false

	## This field will be sent as HostMetadata to Zabbix Server to autoregister the host.
	autoregister = "Example aaa222111cccdddaaaa"

	## This is the period with which self-registrations are sent.
	## Only applies if autoregister is defined in config file
	autoregister_send_period = "1800s"
```

Which tags should expose each input should be controlled, because an unexpected tag could modify the trap key and don't match the Zabbix defined.

For example, in the docker input, each container label is a new tag.

To control this we can add to the input a config like:
```
taginclude = ["host", "container_name"]
```

Allowing only the tags "host" and "container_name" to be used to generate the key (and loosing the information provided in the others tags).


### Agent Active
The ``request`` value in the Zabbix package should be different if the metrics sent are ``trapper`` or ``Zabbix agent (active)``.

### Prefix
We can set a prefix that should be added to all Zabbix keys.

Example with ``prefix = "telegraf."``:
```
measurement,host=hostname valueA=0,valueB=1
->
telegraf.measurement.valueA
telegraf.measurement.valueB
```

### Skip Measurement Prefix
We can skip the measurement prefix that would be added to all Zabbix keys.

Example with ``skip_measurement_prefix = true"`` and ``prefix = "telegraf."``:
```
measurement,host=hostname valueA=0,valueB=1
->
telegraf.valueA
telegraf.valueB
```

Example with ``skip_measurement_prefix = true"`` and ``prefix = ""``:
```
measurement,host=hostname valueA=0,valueB=1
->
valueA
valueB
```

### Autoregister
If this field is active, Telegraf will send an autoregister request to Zabbix, using the content of this field as the ``HostMetadata``.

One request is sent for each of the different values seen for ``host`` tag.

Refer: https://www.zabbix.com/documentation/current/manual/discovery/auto_registration

## Autoregister Send Period
If ``autoregister`` is defined, this field set the interval at which autoregister requests are resend to Zabbix.

The following format should be used: https://golang.org/pkg/time/#ParseDuration

## Examples of metrics converted to traps

### Without tags

```
mem,host=myHost available_percent=14.684620843239944,used=14246531072i 152276442800000000
```

```json
{
  "request":"sender data",
  "data":[
    {
      "host":"myHost",
      "key":"mem.available_percent",
      "value":"14.382719",
      "clock":1522764428
    },
    {
      "host":"myHost",
      "key":"mem.used",
      "value":"14246531072",
      "clock":1522764428
    }
  ]
}
```

### With tags

```
docker_container_net,host=myHost,container_name=laughing_babbage rx_errors=0i,tx_errors=0i 1522764038000000000
```

```json
{
  "request":"sender data",
  "data": [
    {
      "host":"myHost",
      "key":"docker_container_net.rx_errors[laughing_babbage]",
      "value":"0",
      "clock":15227640380
    },
    {
      "host":"myHost",
      "key":"docker_container_net.tx_errors[laughing_babbage]",
      "value":"0",
      "clock":15227640380
    }
  ]
}
```

version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:1.8.3

    working_directory: /go/src/github.com/influxdata/telegraf

    steps:
      - checkout

      - run: git submodule sync --recursive

      - run: git submodule update --recursive --init

      - run:
          name: Check that go fmt has been run.
          command: |
            fmtcount=`git ls-files | grep '.go$' | grep -v Godep | xargs gofmt -l 2>&1 | wc -l`
            if [ $fmtcount -gt 0 ]; then
              echo "run 'go fmt ./...' to format your source code."
              exit 1
            fi

      - run: make
      - run:
          name: Run the tests
          command: go vet ./...
          
      - run:
          name: Simple Integration Tests \n check that version was properly set
          command: |
            telegraf -version
            tmpdir=$(mktemp -d)
            telegraf -sample-config > $tmpdir/config.toml
            exit_if_fail telegraf -config $tmpdir/config.toml \
                -test -input-filter cpu:mem

      - run: ./scripts/orangesys-telegraf.sh
